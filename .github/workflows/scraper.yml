name: Damadam Scraper BotðŸ’›

on:
  schedule:
    - cron: "*/30 * * * *"   # Run every 30 minutes
  workflow_dispatch:         # Manual run option

jobs:
  run-bot:
    runs-on: ubuntu-latest

    steps:
      # ---------------------------
      # 1. Checkout repository
      # ---------------------------
      - name: Checkout Code
        uses: actions/checkout@v3

      # ---------------------------
      # 2. Setup Python
      # ---------------------------
      - name: Setup Python 3.10
        uses: actions/setup-python@v4
        with:
          python-version: "3.10"

      # ---------------------------
      # 3. Install Chrome
      # ---------------------------
      - name: Install Google Chrome
        run: |
          sudo apt update
          sudo apt install -y wget unzip
          wget https://dl.google.com/linux/direct/google-chrome-stable_current_amd64.deb
          sudo dpkg -i google-chrome-stable_current_amd64.deb || sudo apt --fix-broken install -y

      # ---------------------------
      # 4. Install ChromeDriver
      # ---------------------------
      - name: Install ChromeDriver
        run: |
          CHROME_VERSION=$(google-chrome --version | sed 's/Google Chrome //')
          CHROME_MAJOR=$(echo $CHROME_VERSION | cut -d'.' -f1)
          wget https://storage.googleapis.com/chrome-for-testing-public/$CHROME_VERSION/linux64/chromedriver-linux64.zip
          unzip chromedriver-linux64.zip
          sudo mv chromedriver-linux64/chromedriver /usr/local/bin/
          sudo chmod +x /usr/local/bin/chromedriver

      # ---------------------------
      # 5. Install Python Requirements
      # ---------------------------
      - name: Install Requirements
        run: |
          pip install --upgrade pip
          pip install selenium==4.28.1
          pip install oauth2client gspread google-auth google-auth-oauthlib google-auth-httplib2

      # ---------------------------
      # 6. Create credentials.json from secret
      # ---------------------------
      - name: Create credentials.json
        run: |
          echo "${{ secrets.DD_CREDENTIALS_JSON }}" > credentials.json

      # ---------------------------
      # 7. Create Cookie File (EMPTY IF NOT EXISTS IN SECRET)
      # ---------------------------
      - name: Create cookie file
        run: |
          echo "${{ secrets.COOKIE_FILE }}" > damadam_cookies.pkl || true

      # ---------------------------
      # 8. Run the Scraper
      # ---------------------------
      - name: Run Scraper
        env:
          DD_LOGIN_EMAIL: ${{ secrets.DD_LOGIN_EMAIL }}
          DD_LOGIN_PASS: ${{ secrets.DD_LOGIN_PASS }}
          DD_SHEET_ID: ${{ secrets.DD_SHEET_ID }}
          COOKIE_FILE: "damadam_cookies.pkl"
          CREDENTIALS_FILE: "credentials.json"
        run: |
          python Scraper.py
